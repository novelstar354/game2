<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>„Éî„É©„Éü„ÉÉ„Éâ„ÇΩ„É™„ÉÜ„Ç£„Ç¢</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<style>
:root {
  --card-w: min(12vw, 70px);
  --card-h: calc(var(--card-w) * 1.4);
}

body {
  margin: 0;
  background: linear-gradient(#0a5, #063);
  font-family: sans-serif;
  text-align: center;
  color: white;
  touch-action: manipulation;
}

#game {
  max-width: 500px;
  margin: auto;
  padding: 8px;
}

h2 {
  margin: 8px 0;
  font-size: 1.4em;
}

#info {
  display: flex;
  justify-content: space-between;
  font-size: 1em;
  margin-bottom: 5px;
}

.card {
  width: var(--card-w);
  height: var(--card-h);
  border-radius: 6px;
  background-size: cover;
  background-position: center;
  border: 2px solid #222;
  margin: 3px;
  transition: transform 0.15s, opacity 0.2s;
}

.card:active {
  transform: scale(0.95);
}

.row {
  display: flex;
  justify-content: center;
}

.hidden {
  background-image: url("https://upload.wikimedia.org/wikipedia/commons/5/54/Card_back_01.svg");
}

.selected {
  outline: 3px solid red;
}

#deck, #waste {
  display: inline-block;
  margin: 6px;
}

button {
  padding: 10px 18px;
  font-size: 16px;
  border-radius: 8px;
  border: none;
  margin-top: 6px;
}

#clear {
  font-size: 2em;
  color: gold;
  animation: pop 1s infinite alternate;
  margin-top: 10px;
}

@keyframes pop {
  from { transform: scale(1); }
  to { transform: scale(1.2); }
}

@media (min-width: 700px) {
  :root {
    --card-w: 80px;
  }
}
</style>
</head>

<body>

<h2>üÉè „Éî„É©„Éü„ÉÉ„Éâ„ÇΩ„É™„ÉÜ„Ç£„Ç¢</h2>

<div id="game">
  <div id="info">
    <div id="score">„Çπ„Ç≥„Ç¢: 0</div>
    <div id="highscore">„Éè„Ç§„Çπ„Ç≥„Ç¢: 0</div>
  </div>

  <div id="pyramid"></div>

  <div>
    <div id="deck" class="card"></div>
    <div id="waste" class="card"></div>
  </div>

  <button onclick="restart()">„É™„Çπ„Çø„Éº„Éà</button>
</div>

<div id="clear"></div>

<script>
const suits = ["S","H","D","C"];
const values = [
  {v:1,n:"A"}, {v:2,n:"2"}, {v:3,n:"3"}, {v:4,n:"4"},
  {v:5,n:"5"}, {v:6,n:"6"}, {v:7,n:"7"},
  {v:8,n:"8"}, {v:9,n:"9"}, {v:10,n:"10"},
  {v:10,n:"J"}, {v:10,n:"Q"}, {v:10,n:"K"}
];

let deck=[], pyramid=[], selected=null, waste=null;
let score=0, combo=0;
let highScore = Number(localStorage.getItem("pyramidHighScore")) || 0;

function cardImg(c){
  return `https://deckofcardsapi.com/static/img/${c.n}${c.s}.png`;
}

function createDeck(){
  deck=[];
  for(let s of suits){
    for(let v of values){
      deck.push({...v,s});
    }
  }
  deck.sort(()=>Math.random()-0.5);
}

function buildPyramid(){
  pyramid=[];
  let i=0;
  for(let r=0;r<7;r++){
    let row=[];
    for(let c=0;c<=r;c++){
      row.push({...deck[i++], removed:false});
    }
    pyramid.push(row);
  }
}

function canSelect(r,c){
  if(pyramid[r][c].removed) return false;
  if(r===6) return true;
  return pyramid[r+1][c].removed && pyramid[r+1][c+1].removed;
}

function render(){
  const p=document.getElementById("pyramid");
  p.innerHTML="";
  pyramid.forEach((row,r)=>{
    const rowDiv=document.createElement("div");
    rowDiv.className="row";
    row.forEach((card,c)=>{
      const d=document.createElement("div");
      d.className="card";
      if(card.removed){
        d.style.visibility="hidden";
      } else if(!canSelect(r,c)){
        d.classList.add("hidden");
      } else {
        d.style.backgroundImage=`url(${cardImg(card)})`;
        d.onclick=()=>selectCard(card,d);
      }
      rowDiv.appendChild(d);
    });
    p.appendChild(rowDiv);
  });

  const w=document.getElementById("waste");
  w.style.backgroundImage = waste ? `url(${cardImg(waste)})` : "";

  document.getElementById("score").textContent = "„Çπ„Ç≥„Ç¢: " + score;
  document.getElementById("highscore").textContent = "„Éè„Ç§„Çπ„Ç≥„Ç¢: " + highScore;
}

function addScore(p){
  score += p;
  if(score > highScore){
    highScore = score;
    localStorage.setItem("pyramidHighScore", highScore);
  }
}

function selectCard(card, el){
  if(card.v === 13){
    addScore(100);
    card.removed = true;
    render();
    return;
  }
  if(!selected){
    selected = {card, el};
    el.classList.add("selected");
  } else {
    if(selected.card.v + card.v === 13){
      addScore(100 + combo * 20);
      selected.card.removed = true;
      card.removed = true;
    }
    selected = null;
    render();
  }
}

document.getElementById("deck").onclick = ()=>{
  if(deck.length){
    waste = deck.pop();
    combo = 0;
    render();
  }
};

function restart(){
  score=0;
  combo=0;
  waste=null;
  selected=null;
  document.getElementById("clear").textContent="";
  createDeck();
  buildPyramid();
  render();
}

restart();
</script>

</body>
</html>
