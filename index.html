<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ピラミッドソリティア</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  margin: 0;
  background: linear-gradient(#0a5, #063);
  font-family: sans-serif;
  text-align: center;
  color: white;
}

#game { padding: 10px; }

.card {
  width: 60px;
  height: 84px;
  background-size: cover;
  background-position: center;
  border-radius: 6px;
  margin: 4px;
  cursor: pointer;
  transition: transform 0.2s, opacity 0.3s;
  border: 2px solid #222;
}

.card:hover { transform: scale(1.05); }

.hidden {
  background-image: url("https://upload.wikimedia.org/wikipedia/commons/5/54/Card_back_01.svg");
}

.selected {
  outline: 3px solid red;
}

.fade {
  opacity: 0;
  transform: scale(0.3);
}

.row {
  display: flex;
  justify-content: center;
}

#deck, #waste {
  display: inline-block;
  margin: 10px;
}

#deck {
  background-image: url("https://upload.wikimedia.org/wikipedia/commons/5/54/Card_back_01.svg");
}

button {
  padding: 8px 16px;
  font-size: 16px;
  border-radius: 6px;
  border: none;
}

#score, #highscore {
  margin: 5px;
  font-size: 18px;
}

#clear {
  font-size: 32px;
  color: gold;
  margin-top: 20px;
  animation: pop 1s infinite alternate;
}

@keyframes pop {
  from { transform: scale(1); }
  to { transform: scale(1.2); }
}
</style>
</head>
<body>

<h2>ピラミッドソリティア</h2>
<div id="score">スコア: 0</div>
<div id="highscore">ハイスコア: 0</div>

<div id="game">
  <div id="pyramid"></div>

  <div>
    <div id="deck" class="card"></div>
    <div id="waste" class="card"></div>
  </div>

  <br>
  <button onclick="restart()">リスタート</button>
</div>

<div id="clear"></div>

<script>
const suits = ["S", "H", "D", "C"];
const values = [
  {v:1,n:"A"}, {v:2,n:"2"}, {v:3,n:"3"}, {v:4,n:"4"},
  {v:5,n:"5"}, {v:6,n:"6"}, {v:7,n:"7"},
  {v:8,n:"8"}, {v:9,n:"9"}, {v:10,n:"10"},
  {v:10,n:"J"}, {v:10,n:"Q"}, {v:10,n:"K"}
];

let deck=[], pyramid=[], selected=null, waste=null;
let score=0, combo=0;
let highScore = Number(localStorage.getItem("pyramidHighScore")) || 0;

document.getElementById("highscore").textContent = "ハイスコア: " + highScore;

function cardImage(card){
  return `https://deckofcardsapi.com/static/img/${card.n}${card.s}.png`;
}

function createDeck(){
  deck=[];
  for(let s of suits){
    for(let v of values){
      deck.push({...v, s});
    }
  }
  deck.sort(()=>Math.random()-0.5);
}

function buildPyramid(){
  pyramid=[];
  let i=0;
  for(let r=0;r<7;r++){
    let row=[];
    for(let c=0;c<=r;c++){
      row.push({ ...deck[i++], removed:false });
    }
    pyramid.push(row);
  }
}

function canSelect(r,c){
  if(pyramid[r][c].removed) return false;
  if(r===6) return true;
  return pyramid[r+1][c].removed && pyramid[r+1][c+1].removed;
}

function render(){
  const p=document.getElementById("pyramid");
  p.innerHTML="";
  pyramid.forEach((row,r)=>{
    const div=document.createElement("div");
    div.className="row";
    row.forEach((card,c)=>{
      const d=document.createElement("div");
      d.className="card";
      if(card.removed){
        d.style.visibility="hidden";
      } else if(!canSelect(r,c)){
        d.classList.add("hidden");
      } else {
        d.style.backgroundImage=`url(${cardImage(card)})`;
        d.onclick=()=>selectCard(card,d);
      }
      div.appendChild(d);
    });
    p.appendChild(div);
  });

  const w=document.getElementById("waste");
  if(waste){
    w.style.backgroundImage=`url(${cardImage(waste)})`;
  } else {
    w.style.backgroundImage="";
  }

  document.getElementById("score").textContent="スコア: "+score;
  document.getElementById("highscore").textContent="ハイスコア: "+highScore;
}

function addScore(p){
  score+=p;
  if(score>highScore){
    highScore=score;
    localStorage.setItem("pyramidHighScore",highScore);
  }
}

function selectCard(card,el){
  if(card.v===13){
    addScore(100);
    card.removed=true;
    render();
    return;
  }

  if(!selected){
    selected={card,el};
    el.classList.add("selected");
  }else{
    if(selected.card.v + card.v === 13){
      addScore(100 + combo*20);
      selected.card.removed=true;
      card.removed=true;
    }
    selected=null;
    render();
  }
}

document.getElementById("deck").onclick=()=>{
  if(deck.length){
    waste=deck.pop();
    combo=0;
    render();
  }
};

function restart(){
  score=0;
  combo=0;
  waste=null;
  selected=null;
  document.getElementById("clear").textContent="";
  createDeck();
  buildPyramid();
  render();
}

restart();
</script>

</body>
</html>
