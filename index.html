<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ãƒ”ãƒ©ãƒŸãƒƒãƒ‰ã‚½ãƒªãƒ†ã‚£ã‚¢</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  margin: 0;
  background: linear-gradient(#0a5, #063);
  font-family: sans-serif;
  text-align: center;
  color: white;
}

#game {
  padding: 10px;
}

h2 {
  margin: 10px 0;
}

#score, #highscore {
  font-size: 18px;
  margin: 5px;
}

.card {
  width: 60px;
  height: 80px;
  background: white;
  border-radius: 8px;
  border: 2px solid #222;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  font-weight: bold;
  margin: 4px;
  cursor: pointer;
  transition: transform 0.2s, opacity 0.3s;
}

.card:hover { transform: scale(1.05); }

.hidden { background: #222; cursor: default; }

.selected { border: 3px solid red; }

.fade {
  opacity: 0;
  transform: scale(0.3);
}

#pyramid .row {
  display: flex;
  justify-content: center;
}

#deck, #waste {
  display: inline-block;
  margin: 10px;
}

button {
  padding: 8px 16px;
  font-size: 16px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
}

#clear {
  font-size: 32px;
  color: gold;
  margin-top: 20px;
  animation: pop 1s infinite alternate;
}

@keyframes pop {
  from { transform: scale(1); }
  to { transform: scale(1.2); }
}
</style>
</head>
<body>

<h2>ãƒ”ãƒ©ãƒŸãƒƒãƒ‰ã‚½ãƒªãƒ†ã‚£ã‚¢</h2>
<div id="score">ã‚¹ã‚³ã‚¢: 0</div>
<div id="highscore">ãƒã‚¤ã‚¹ã‚³ã‚¢: 0</div>

<div id="game">
  <div id="pyramid"></div>

  <div>
    <div id="deck" class="card hidden">å±±</div>
    <div id="waste" class="card"></div>
  </div>

  <br>
  <button onclick="restart()">ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ</button>
  <button onclick="resetHighScore()">ãƒã‚¤ã‚¹ã‚³ã‚¢å‰Šé™¤</button>
</div>

<div id="clear"></div>

<script>
const values = [1,2,3,4,5,6,7,8,9,10,10,10,10];
let deck = [];
let pyramid = [];
let selected = null;
let waste = null;
let score = 0;
let combo = 0;
let highScore = Number(localStorage.getItem("pyramidHighScore")) || 0;

document.getElementById("highscore").textContent = "ãƒã‚¤ã‚¹ã‚³ã‚¢: " + highScore;

function createDeck(){
  deck = [];
  for(let i=0;i<4;i++){
    for(let v of values) deck.push(v);
  }
  deck.sort(()=>Math.random()-0.5);
}

function buildPyramid(){
  pyramid = [];
  let index = 0;
  for(let r=0;r<7;r++){
    let row = [];
    for(let c=0;c<=r;c++){
      row.push({ value: deck[index++], removed:false });
    }
    pyramid.push(row);
  }
}

function canSelect(r,c){
  if(pyramid[r][c].removed) return false;
  if(r === 6) return true;
  return pyramid[r+1][c].removed && pyramid[r+1][c+1].removed;
}

function render(){
  const p = document.getElementById("pyramid");
  p.innerHTML = "";
  pyramid.forEach((row,r)=>{
    const rowDiv = document.createElement("div");
    rowDiv.className = "row";
    row.forEach((card,c)=>{
      const d = document.createElement("div");
      d.className = "card";
      if(card.removed){
        d.style.visibility = "hidden";
      } else if(!canSelect(r,c)){
        d.classList.add("hidden");
      } else {
        d.textContent = card.value;
        d.onclick = ()=>selectCard(card, d);
      }
      rowDiv.appendChild(d);
    });
    p.appendChild(rowDiv);
  });

  const w = document.getElementById("waste");
  w.textContent = waste ?? "";
  w.onclick = ()=>selectWaste();

  document.getElementById("score").textContent = "ã‚¹ã‚³ã‚¢: " + score;
  document.getElementById("highscore").textContent = "ãƒã‚¤ã‚¹ã‚³ã‚¢: " + highScore;
}

function removeCard(card, el){
  el.classList.add("fade");
  setTimeout(()=>{
    card.removed = true;
    render();
  },200);
}

function addScore(point){
  score += point;
  if(score > highScore){
    highScore = score;
    localStorage.setItem("pyramidHighScore", highScore);
  }
}

function selectCard(card, el){
  if(card.value === 13){
    addScore(100);
    combo++;
    removeCard(card, el);
    checkClear();
    return;
  }

  if(!selected){
    selected = {card, el};
    el.classList.add("selected");
  } else {
    if(selected.card.value + card.value === 13){
      addScore(100 + combo * 20);
      combo++;
      removeCard(selected.card, selected.el);
      removeCard(card, el);
    } else {
      combo = 0;
    }
    selected = null;
  }
}

function selectWaste(){
  if(!waste) return;
  if(waste === 13){
    addScore(100);
    waste = null;
    render();
    return;
  }
  if(!selected){
    selected = { value:waste };
  } else {
    if(selected.value + waste === 13){
      addScore(100);
      waste = null;
      selected = null;
      render();
    }
  }
}

document.getElementById("deck").onclick = ()=>{
  if(deck.length){
    waste = deck.pop();
    combo = 0;
    render();
  }
};

function checkClear(){
  const left = pyramid.flat().some(c=>!c.removed);
  if(!left){
    document.getElementById("clear").textContent = "ğŸ‰ CLEAR!! ğŸ‰";
  }
}

function restart(){
  score = 0;
  combo = 0;
  selected = null;
  waste = null;
  document.getElementById("clear").textContent = "";
  createDeck();
  buildPyramid();
  render();
}

function resetHighScore(){
  if(confirm("ãƒã‚¤ã‚¹ã‚³ã‚¢ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")){
    localStorage.removeItem("pyramidHighScore");
    highScore = 0;
    render();
  }
}

restart();
</script>

</body>
</html>
